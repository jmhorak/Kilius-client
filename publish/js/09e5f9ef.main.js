function KiliusLink(e){var t=this;e=e||{},t.shortLink=e.shortLink||"",t.longLink=e.longLink||"",t.hits=e.hits?e.hits.length||0:0,t.date=e.createDate||new Date,t.clip=null,t.positionStale=ko.observable(!1),t.updatePosition=ko.computed(function(){return t.positionStale()}).extend({throttle:300}),t.displayShortLink=ko.computed(function(){var e=t.shortLink;return e.substring(e.indexOf("kili"))})}function KiliusModel(){var e=this,t="webkitTransitionEnd transitionend MSTransitionEnd oTransitionEnd",n=new Promise,r=new Promise,i=new Promise;e.user="k",e.supportAnimation=$("html").hasClass("cssanimations"),e.supportFlash=function(){var e=navigator.mimeTypes["application/x-shockwave-flash"];return e?!!e.enabledPlugin:!1}(),e.links=ko.observableArray([]),e.link=ko.observable(),e.newLink=ko.computed(function(){var t=e.link();return/.*\..*/.test(t)&&(/.*:.*/.test(t)||(t="http://"+t)),t}),e.hasLinks=ko.computed(function(){return e.links().length>0}),e.errorMsg=ko.computed({read:function(){return kilius.comms.errorMsg()},write:function(e){kilius.comms.errorMsg(e)}}),e.animated={logo:ko.observable(!1),table:ko.observable(!1),links:ko.observable(!1)},n.whenDone(function(){var t;e.animated.table(!0),i.whenDone(e.showTable)}),r.whenDone(function(){e.animated.links(!0),e.repositionCopyLinks()}),$("#mainBox").bind(t,function(e){e.target===this&&n.resolve()}),$(".table-container").bind(t,function(e){e.target===this&&r.resolve()}),e.showTable=function(){e.hasLinks()&&(element=$(".table-container")[0],element&&(element.className=element.className.replace("fromTop","toBottom")))},e.postLink=function(){kilius.comms.postNewLink(e.newLink()).then(e.addNewLink,function(t){e.errorMsg(t)})},e.repositionCopyLinks=function(){$.each(e.links(),function(e,t){t.positionStale(!0)})},e.addUserHistoryFromJSON=function(t){var n=t.history||[];n.sort(function(e,t){return t.createDate-e.createDate}),$.each(n,function(t,n){e.links.push(new KiliusLink(n))}),i.resolve()},e.addNewLink=function(t){e.links.unshift(new KiliusLink({shortLink:t,longLink:e.newLink(),hits:0,createDate:new Date})),e.link(""),e.errorMsg(""),e.showTable(),e.repositionCopyLinks()},$(window).resize(e.repositionCopyLinks),kilius.comms.getUserHistory(e.user).then(e.addUserHistoryFromJSON),e.animated.logo(!0),e.supportAnimation||(n.resolve(),r.resolve())}function KiliusComms(){var e=this;e.errorMsg=ko.observable(""),e.getUserHistory=function(e){var t=new Promise;return $.getJSON("/"+e+"/history",function(e){t.resolve(e)}),t},e.postNewLink=function(t){var n=new Promise;return $.ajax({url:"/+/",type:"POST",data:JSON.stringify({url:t}),contentType:"application/json",processData:!1,error:function(t,r,i){var s=null;try{s=JSON.parse(t.responseText),s=s.message}catch(o){s=null}s||(s=["The Kili.us server reported a problem: ",r?r[0].toUpperCase()+r.slice(1):"Error"," - ",i?i:"General Error"].join("")),n.reject(s),e.errorMsg(s)},success:function(e,t,r){r.status===201?n.resolve(r.getResponseHeader("Location")):n.reject("The server did not reply to the request in the correct format")}}),n},$.ajaxSetup({dataType:"json"})}(!window.console||!console.log)&&function(){var e=function(){},t=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","markTimeline","table","time","timeEnd","timeStamp","trace","warn"],n=t.length,r=window.console={};while(n--)r[t[n]]=e}(),ko.bindingHandlers.opacity={init:function(e,t){t()?$(e).addClass("opaque"):$(e).addClass("transparent")},update:function(e,t){t()?e.className=e.className.replace("transparent","opaque"):e.className=e.className.replace("opaque","transparent")}},ko.bindingHandlers.copyElement={init:function(e,t,n,r){r.clip=new ZeroClipboard.Client,r.clip.setText(r.shortLink),r.clip.setHandCursor(!0),r.clip.setCSSEffects(!0)},update:function(e,t,n,r){t()&&(r.clip.domElement||r.clip.glue(e),r.clip.reposition(),r.positionStale(!1))}},window.kilius={},$(document).ready(function(){setTimeout(function(){kilius.comms=new KiliusComms,kilius.model=new KiliusModel,ko.applyBindings(kilius.model),ZeroClipboard.setMoviePath("/flash/ZeroClipboard.swf")},1)});